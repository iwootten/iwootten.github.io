<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Ian Wootten - Web Developer, Cardiff</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fonts/open-sans.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-263865-2', 'ianwootten.co.uk');
      ga('send', 'pageview');

    </script>
</head>
<body>

<div class="container blog">
    <header>
      <nav>
      <ul class="nav">
        <li><a class="blog active" href="/">Blog</a></li>
        <li><a class="javascript " href="/category/javascript">Javascript</a></li>
        <li><a class="web-apps " href="/category/web-apps">Web Apps</a></li>
        <li><a class="about" href="/about">About</a></li>
        <li><a class="contact" href="/contact">Contact</a></li>
      </ul>
      </nav>
      <div class="clear"></div>
    </header>

      
        <div class="post">
          <h1><a href="/2017/04/18/user-generated-forms-with-wtforms">User Generated Forms with WTForms</a></h1>
      <div class="author_meta">18 Apr 2017</div>

          <p>As part of my past work with the Office for National Statistics (ONS), I worked with the survey runner team to add additional features to their <a href="https://github.com/ONSdigital/eq-survey-runner">Electronic Questionnaire</a> which enabled the business to take regular surveys electronically via the web. During my final months there, I took it upon myself to tackle what was seen to be one of the projects major pieces of technical debt, its use of a custom form renderer. This was identified early on as a feature that shared a lot in common with existing form libraries, but our current renderer wasn&#39;t able to be easily isolated from the rest of the system and was therefore pushed onto a debt backlog after a possible approach had been prototyped.</p>
<p>Due to the hard work of the entire team, we&#39;d made some strategic changes to the system that meant this was possible in my later months. <a href="https://github.com/wtforms/wtforms">WTForms</a> was the library we wanted to use, but we needed a number of features which weren&#39;t documented or supported out of the box. Chief among these was the ability to create forms dynamically, informed by a JSON description.</p>
<h2 id="dynamic-form-definition">Dynamic form definition</h2>
<p>WTForms generally expects metaclasses that describe form definitions, as per the following example from their docs:</p>
<div class='hljs'><pre><code class='python'><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyForm</span><span class="hljs-params">(Form)</span>:</span>
  first_name = StringField(<span class="hljs-string">u'First Name'</span>, validators=[validators.input_required()])
  last_name  = StringField(<span class="hljs-string">u'Last Name'</span>, validators=[validators.optional()])</code></pre></div><p>I found it easier to think as these definitions as &#39;schemas&#39; for form classes. Typically you&#39;d use them to describe a class which doesn&#39;t change, so WTForms use of them for describing our dynamic forms led to some problems.</p>
<p>When the instantiated form is passed to jinja and rendered as part of a template helper call, appropriate inputs will be rendered for each field definition, with names corresponding to the attribute names (first_name, last_name). We can then take the post request form and pass as an argument to our form class to validate during a submission.</p>
<div class='hljs'><pre><code class='python'><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register</span><span class="hljs-params">(request)</span>:</span>
  form = MyForm(request.POST)
  <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">'POST'</span> <span class="hljs-keyword">and</span> form.validate():
      user = MyForm()
      user.first_name = form.first_name.data
      user.last_name = form.last_name.data
      user.save()
      redirect(<span class="hljs-string">'register'</span>)
  <span class="hljs-keyword">return</span> render_response(<span class="hljs-string">'register.html'</span>, form=form)</code></pre></div><p>The approach taken for the ONS was to read in a json description from file and set field attributes dynamically within a method upon what was essentially an empty form class. I&#39;ve simplified the actual project code below to remove detail outside the example.</p>
<div class='hljs'><pre><code class='python'><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_answer_fields</span><span class="hljs-params">(question, data)</span>:</span>
    answer_fields = {}
    <span class="hljs-keyword">for</span> answer <span class="hljs-keyword">in</span> question[<span class="hljs-string">'answers'</span>]:
        name = answer.get(<span class="hljs-string">'label'</span>) <span class="hljs-keyword">or</span> question.get(<span class="hljs-string">'title'</span>)
        answer_fields[answer[<span class="hljs-string">'id'</span>]] = get_field(answer, name)
    <span class="hljs-keyword">return</span> answer_fields

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_form</span><span class="hljs-params">(json_for_page, data)</span>:</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QuestionnaireForm</span><span class="hljs-params">(Form)</span>:</span>
        answer_fields = {}

        <span class="hljs-keyword">for</span> question <span class="hljs-keyword">in</span> SchemaHelper.get_questions(json_for_page):

            answer_fields.update(get_answer_fields(question, data))

            <span class="hljs-keyword">for</span> answer_id, field <span class="hljs-keyword">in</span> answer_fields.items():
                setattr(QuestionnaireForm, answer_id, field)

        <span class="hljs-keyword">if</span> data:
            form = QuestionnaireForm(MultiDict(data))
        <span class="hljs-keyword">else</span>:
            form = QuestionnaireForm()

        <span class="hljs-keyword">return</span> form</code></pre></div><p>Here you see that we retrieve details of the json structure for a survey page, and maintain a map of answer fields to be set on the class. The answer ids within the page structure will always be unique and is used as the key for the mapping to each field type. In this way, the resultant form is a collection of fields able to be driven dynamically from our json description.</p>
<h2 id="validating-dynamic-forms">Validating Dynamic Forms</h2>
<p>As well as the fields on our forms being customisable, the validators used upon them were too. This meant for instance, that some fields were optional or required and the messages used for validation needed to be informed by the survey&#39;s json description.</p>
<p>Below you can see an example of the message for a DateRequired validator being updated based on the message from the schema. You can also see an example of modifying the behaviour of the validator, based on whether or not the date validator includes a day attribute as part of the data sent. This allows for the same validator to be used for different form representations of dates.</p>
<div class='hljs'><pre><code class='python'><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DateRequired</span><span class="hljs-params">(object)</span>:</span>
     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, message=None)</span>:</span>
         <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message:
             message = error_messages[<span class="hljs-string">'MANDATORY'</span>]
         self.message = message

     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span><span class="hljs-params">(self, form, field)</span>:</span>
         <span class="hljs-keyword">if</span> hasattr(form, <span class="hljs-string">'day'</span>):
             <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> form.day.data <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> form.month.data <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> form.year.data:
                 <span class="hljs-keyword">raise</span> validators.StopValidation(self.message)
         <span class="hljs-keyword">else</span>:
             <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> form.month.data <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> form.year.data:
                 <span class="hljs-keyword">raise</span> validators.StopValidation(self.message)</code></pre></div><p>In more complex situations, it was necessary to pass custom data to our validators to later check against. You can see below, when validating custom date ranges, we pass the &#39;to&#39; date and initialise the validator with it, before the call to the validator is made with the form (in this case a subform for just a date).</p>
<div class='hljs'><pre><code class='python'><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DateRangeCheck</span><span class="hljs-params">(object)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, to_field_data=None, messages=None)</span>:</span>
        self.to_field_data = to_field_data
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> messages:
            messages = error_messages
        self.messages = messages

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span><span class="hljs-params">(self, form, from_field)</span>:</span>

        <span class="hljs-keyword">if</span> form.day <span class="hljs-keyword">and</span> form.month <span class="hljs-keyword">and</span> form.year <span class="hljs-keyword">and</span> self.to_field_data:
            to_date_str = <span class="hljs-string">"{:02d}/{:02d}/{}"</span>.format(int(self.to_field_data[<span class="hljs-string">'day'</span>] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>), int(self.to_field_data[<span class="hljs-string">'month'</span>] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>),
                                                    self.to_field_data[<span class="hljs-string">'year'</span>] <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>)
            from_date_str = <span class="hljs-string">"{:02d}/{:02d}/{}"</span>.format(int(form.day.data <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>), int(form.month.data <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>),
                                                      form.year.data <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>)

            from_date = datetime.strptime(from_date_str, <span class="hljs-string">"%d/%m/%Y"</span>)
            to_date = datetime.strptime(to_date_str, <span class="hljs-string">"%d/%m/%Y"</span>)

            date_diff = to_date - from_date

            <span class="hljs-keyword">if</span> date_diff.total_seconds() == <span class="hljs-number">0</span>:
                <span class="hljs-keyword">raise</span> validators.ValidationError(self.messages[<span class="hljs-string">'INVALID_DATE_RANGE_TO_FROM_SAME'</span>])
            <span class="hljs-keyword">elif</span> date_diff.total_seconds() &lt; <span class="hljs-number">0</span>:
                <span class="hljs-keyword">raise</span> validators.ValidationError(self.messages[<span class="hljs-string">'INVALID_DATE_RANGE_TO_BEFORE_FROM'</span>])</code></pre></div><p>We actually found it necessary to go one step further in that we needed to halt validation for forms in surveys which were considered optional. The solution was an OptionalForm, allowing empty forms to be considered valid if they had no content.</p>
<div class='hljs'><pre><code class='python'><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptionalForm</span><span class="hljs-params">(object)</span>:</span>
     <span class="hljs-string">"""
     Allows completely empty form and stops the validation chain from continuing.
     Will not stop the validation chain if any one of the fields is populated.
     """</span>
     field_flags = (<span class="hljs-string">'optional'</span>,)

     <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span><span class="hljs-params">(self, form, field)</span>:</span>
         empty_form = <span class="hljs-keyword">True</span>

         <span class="hljs-keyword">for</span> formfield <span class="hljs-keyword">in</span> form:
             has_raw_data = hasattr(formfield, <span class="hljs-string">'raw_data'</span>)

             is_empty = has_raw_data <span class="hljs-keyword">and</span> len(formfield.raw_data) == <span class="hljs-number">0</span>
             is_blank = has_raw_data <span class="hljs-keyword">and</span> len(formfield.raw_data) &gt;= <span class="hljs-number">1</span> \
                 <span class="hljs-keyword">and</span> isinstance(formfield.raw_data[<span class="hljs-number">0</span>], string_types) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> formfield.raw_data[<span class="hljs-number">0</span>]

             <span class="hljs-comment"># By default we'll receive empty arrays for values not posted, so need to allow empty lists</span>
             empty_field = <span class="hljs-keyword">True</span> <span class="hljs-keyword">if</span> is_empty <span class="hljs-keyword">else</span> is_blank

             empty_form &amp;= empty_field

         <span class="hljs-keyword">if</span> empty_form:
             <span class="hljs-keyword">raise</span> validators.StopValidation()</code></pre></div><h2 id="final-thoughts">Final Thoughts</h2>
<p>One of the main pain points with WTForms adoption was the lack of form-level validation supported out of the box. We had for instance a number of custom forms, which fell outside the generic examples above, where it was necessary to override the validate method on the form itself. This added complexity to the form that I felt belonged in a validator, similar to the field level ones WTForms supports defined in separate classes. Adding to option of form validators would be great and cover most of the bases and seems like an <a href="https://github.com/wtforms/wtforms/issues/55">oft-requested feature</a>.</p>
<p> I felt that the use of WTForms really helped create a far more structured approach to form design, creation and validation within our project. Getting to the point where we could isolate and shift it over to a common library was a real achievement.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/python">python</a>,
                
                <a href="/tag/wtforms">wtforms</a>,
                
              
              | <a href="2017/04/18/user-generated-forms-with-wtforms/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2016/01/20/there-s-no-such-thing-as-a-side-project">There&#39;s No Such Thing as a Side Project</a></h1>
      <div class="author_meta">20 Jan 2016</div>

          <p>As a freelancer who has worked with clients using non disclosure agreements in the past, it&#39;s often difficult to showcase or build a portfolio of my work. I&#39;m not alone on this, I know. Sarah Parmenter for one <a href="https://twitter.com/sazzy/status/360732051298713600">has posted</a> about this problem as a designer.</p>
<p>As a developer, I sometimes feel it&#39;s impossible to easily show a concise representation of my work in a public arena anyway. How can I convey my role in what will usually be a complex process involving many other parties? How can I show what&#39;s involved in selecting and iterating on a simple idea to reach a final build? How can I wrap up all the knowledge I&#39;ve learnt about a domain if the reader knows nothing? How can I do all this when the final product isn&#39;t available to interact with anywhere? The short answer is: I can&#39;t.</p>
<p>Somehow, despite all these problems of showing off my past work, I&#39;m still able to find clients. In fact, often I&#39;m lucky enough to have clients find me. I put this down in part to twitter, where people can find and follow me and learn more about my skills and character. The six degrees of separation really helps me outâ€¦</p>
<h2 id="using-by-products-to-sell-yourself">Using By-products to Sell Yourself</h2>
<p>But there&#39;s another weapon any designer or developer has in their arsenal that can be used to demonstrate why we should be hired and that&#39;s our own projects. I&#39;m pretty sure that without showcasing any projects of my own, I&#39;d never have got my first job in the industry as I had no client work to put in my portfolio.</p>
<p>You may wonder why I don&#39;t call such endeavours &#39;side-projects&#39;? After all that seems to be the convention. Well, in the case of my portfolio, they serve as much of an example of skills as any of my paid work. It seems a disservice to belittle them by classing them in such a way. Everything I&#39;ve done is a project in it&#39;s own right.</p>
<p>Jason Fried of 37signals has written in the past about <a href="http://37signals.com/svn/posts/1620-sell-your-by-products">selling your by-products</a>. Well, any project I create could be considered a by-product of working within our industry. I could choose to sell any one of those, but equally I can use them to sell myself.</p>
<p>There are some caveats that go along with using our own projects in this type of way. Firstly, we need to make it abundantly clear when listed that these are our own. We don&#39;t want to confuse potential clients about the nature of any project. On my own site, I list the two underneath one another, titled &#39;work&#39; and &#39;projects&#39; respectively.</p>
<p>Secondly, we need to treat them with the same level of professionalism as we would do for any client based work. This can be difficult given we&#39;ve not faced any restrictions on how to approach a task. As developers we&#39;re constantly told to &#39;ship early, ship often&#39;, but we I&#39;d balance that with &#39;don&#39;t ship <em>too</em> early&#39;. There&#39;s no point in showcasing any projects that you yourself aren&#39;t proud of. I find a top tip here is to track my projects as I would do for any client. Knowing I&#39;m officially on the clock whilst pursuing my own endeavours makes me think differently about them.</p>
<p>In thinking about my entire body of work as a whole, I&#39;ve gained new perspective the value of everything I create. In fact, I&#39;d argue the projects I spend my own time on better illustrates where my abilities and interests lie. In turn, this will hopefully attract clients who share the same interests. There&#39;s also something to be said for keeping our brains active and solving problems, even when they&#39;re our own. I much prefer this than incessantly looking to plug gaps in in my calendar.</p>
<p>I can already hear a bunch of you clambering from the rooftops, reeling at the thought of doing work for nothing and that actually, you&#39;d prefer to be paid for what you&#39;re good at. In an odd sort of way, isn&#39;t this spec work? Really, working hard on your own projects should be treated as an investment - the payoff being future work you will be offered as a result of demonstrating you&#39;re capable. If your portfolio is bare, then working on something to showcase is of use to get you to the next level. If not, then working on your own projects allows you to, as <a href="http://jessicahische.is/aprocrastiworker">Jessica Hische so eloquently puts it</a>: &#39;exercise parts of my brain that go unused during client time&#39;. I personally find that having the freedom to be able to bounce my ideas around and get feedback from friends one thing that motivates me to push onward with them.</p>
<h2 id="projects-as-businesses">Projects as Businesses</h2>
<p>There&#39;s also the opportunity for your projects to become your sole business. <a href="http://dribbble.com">Dribbble</a>, <a href="http://gumroad.com">Gumroad</a> and <a href="http://teuxdeux.com">TeuxDeux</a> are all great examples of successful self initiated projects. Simon Willison and Natalie Downe sold their fantastic startup <a href="http://lanyrd.com">Lanyrd</a> to Eventbrite. The story of how they created this whilst travelling the world is <a href="http://blog.natbat.net/post/61658401806/lanyrd-from-idea-to-exit-the-story-of-our-startup">really quite a read</a>. Lanyrd started out as a small project and eventually ended up receiving funding from Y Combinator. I&#39;m not saying you should create projects with a view to them being acquired, but if they&#39;re good ideas, hey who knows what may follow?</p>
<p>If your own projects enjoy moderate success, there&#39;s also scope for making a little extra income over your client work. Given they&#39;ve been approached in a professional manner, it could be possible to wrap them up as commercial products. If you work with open source, you might consider selling a commercial licence for your handiwork. That may not mean you can retire on the profits or move away from client work altogether, but with enough of these projects, you may be in a position to adopt a more comfortable working situation. Certain members of our industry have a knack for pulling this off well. <a href="http://drewwilson.com">Drew Wilson</a> and <a href="http://soff.es">Sam Soffes</a> are two sickeningly prolific projectors to take note of, who both have built up a stack of projects which together earn them enough not to worry about client work.</p>
<h2 id="value-it-all">Value It All</h2>
<p>So let&#39;s not worry about the value of building side-projects, or as I prefer, &#39;projects&#39;. Don&#39;t feel like that your work is &#39;just&#39; a side-project, or you&#39;ll end up treating it as such. There&#39;s going to be value in any project you embark on, either directly or indirectly, short or long term, through skills or financially. Just get out there, make great stuff and show it to people.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/projects">projects</a>,
                
                <a href="/tag/business">business</a>,
                
              
              | <a href="2016/01/20/there-s-no-such-thing-as-a-side-project/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2015/06/30/blogging-with-metalsmith">Blogging with Metalsmith</a></h1>
      <div class="author_meta">30 Jun 2015</div>

          <p>I&#39;m switching blogging platforms once more. Moving from Wordpress to Jekyll enabled me to no longer deal with the multitude of updates and protected me hacks I could be susceptible to, but Jekyll being written in Ruby (a language I&#39;m not overly familiar with) has been a problem. I&#39;ve been able to cobble together <a href="http://www.ianwootten.co.uk/2014/06/02/porting-a-wordpress-blog-to-jekyll-part-2/">scripts</a> to deal with the custom parts of my blog build, but it&#39;s never felt like home.</p>
<p>I&#39;ve decided to start using <a href="http://metalsmith.io">Metalsmith</a> - a static site generator written in Javascript. It&#39;s existed before my switch to Jekyll and now seems to have enough of a plugin ecosystem in order to provide a collection of plugins to provide behaviour I need to make use of.</p>
<h2 id="metalsmith">Metalsmith</h2>
<p>Metalsmith operates much like a task runner like gulp, where a set of functions manipulate a number of files, one after another in order to eventually build a static site to your liking. A simple build script could be as follows:</p>
<div class='hljs'><pre><code class='javascript'><span class="hljs-keyword">var</span> Metalsmith = <span class="hljs-built_in">require</span>(<span class="hljs-string">'metalsmith'</span>),
    markdown   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'metalsmith-markdown'</span>),
    templates  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'metalsmith-templates'</span>);

Metalsmith(__dirname)
  .use(markdown())
  .use(templates(<span class="hljs-string">'swig'</span>))
  .build();</code></pre></div><p>This is just standard node script with dependencies installed via npm. Metalsmith assumes defaults of src and build for the source of markdown and destination of html. An example of markdown containing some useful front-matter might be as follows:</p>
<div class='hljs'><pre><code class='markdown'><span class="hljs-horizontal_rule">---</span>
title: Blogging with Metalsmith
author: Ian
date: 2015-06-30
year: 2015
month: 2015/06
categories:
  - Javascript
tags:
  - metalsmith
<span class="hljs-header">  - javascript
---</span>
I'm switching blogging platforms once more...</code></pre></div><p>It also assumes a default template directory under templates, containing a default post template &#39;post.html&#39; - which in the example is written in a swig template as below.</p>
<div class='hljs'><pre><code class='twig'><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"post"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/</span></span></span><span class="hljs-variable">{{ path }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span>&gt;</span></span><span class="hljs-variable">{{ title }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"post_date"</span>&gt;</span></span><span class="hljs-variable">{{ <span class="hljs-function"><span class="hljs-keyword">date</span></span> | <span class="hljs-function"><span class="hljs-keyword">date</span><span class="hljs-params">('d M Y')</span></span> }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    </span><span class="hljs-variable">{{ contents | safe }}</span><span class="xml">
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span></span></code></pre></div><p>I&#39;ve managed to reduce my build time (though I&#39;m not currently compiling sass and have added a new sitemap), but am much more familiar with the toolchain in question. Hopefully that&#39;ll lead to further, more frequent updates not just in content, but also the design of my company site and this blog.</p>
<p>I&#39;ll be adding future blogs about my metalsmith toolchain and hurdles with that I&#39;ve overcome.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/metalsmith">metalsmith</a>,
                
                <a href="/tag/blogging">blogging</a>,
                
                <a href="/tag/javascript">javascript</a>,
                
              
              | <a href="2015/06/30/blogging-with-metalsmith/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2014/09/15/processing-camera-raws-with-openimageio-and-python">Processing Camera RAWs with OpenImageIO and Python</a></h1>
      <div class="author_meta">15 Sep 2014</div>

          <p>I recently discovered the library <a href="http://www.openimageio.org">OpenImageIO</a>, an awesome tool for reading and writing image files. What makes this of particular interest is the sheer variety of image files supported (BMP, Cineon, JPG, JPG-2000, GIF, DPX, OpenEXR, Targa, TIFF) (as well as variety of camera raw formats) and the fact it can perform image transformations upon them very easily. Given it&#39;s designed for use in media and VFX environments it sounds like it will be useful for the type of work I&#39;ve previously been involved with in stop motion.</p>
<p>Additionally, it comes with Python bindings, so you can do all of this without having to learn C++ if, like me, it&#39;s been 10 years since you last used it. It also means not having to resort to use of the commandline tools I&#39;ve often used in the past for similar transformations.</p>
<h2 id="mac-installation">Mac Installation</h2>
<p>I&#39;m on a mac and as such, brew is my weapon of choice for installing libraries. Unfortunately, openimageio is only available through a tap and an old version at that. I managed to compile outside of brew, but found that I couldn&#39;t get python to read the bindings correctly. I wanted to install a 1.5 version of the library, so found the best solution was to download the formula, modify it and tap homebrew/science to get the libraries it depends on. Your local openimageio formula takes precedence over the tapped version, so it won&#39;t get overwritten.</p>
<div class='hljs'><pre><code class='bash'>wget -O /usr/<span class="hljs-built_in">local</span>/Library/Formula/openimageio.rb https://raw.githubusercontent.com/Homebrew/homebrew-science/master/openimageio.rb
brew tap homebrew/science</code></pre></div><p>You can edit the formula here if required, using more recent version.</p>
<div class='hljs'><pre><code class='bash'>brew install openimageio</code></pre></div><p>If all goes to plan, brew should install openimageio along with all dependencies. Additionally, I&#39;ve edited my $DYLD_LIBRARY_PATH to include the path to the installation (/usr/local/Cellar/openimageio/1.5.3dev/lib).</p>
<h1 id="reading-and-processing-raws">Reading and Processing RAWs</h1>
<p>OpenImageIO uses the ImageBuf class to handle representation and manipulation of images in memory and functions of the ImageBufAlgo class to transform them. It&#39;s best to demonstrate through some examples.</p>
<div class='hljs'><pre><code class='python'><span class="hljs-keyword">import</span> OpenImageIO <span class="hljs-keyword">as</span> oiio

<span class="hljs-comment"># Read a camera raw, crop and write out to a tiff</span>
buf = oiio.ImageBuf(<span class="hljs-string">"Dino_001_01_X1_0066.cr2"</span>)
cropped = oiio.ImageBuf()
oiio.ImageBufAlgo.crop(cropped, buf, oiio.ROI(<span class="hljs-number">1208</span>, <span class="hljs-number">4901</span>, <span class="hljs-number">814</span>, <span class="hljs-number">2385</span>))
cropped.write(<span class="hljs-string">"cropped.tiff"</span>)

<span class="hljs-comment"># Create a new larger buffer and paste the crop into it, vertically centred</span>
extended = oiio.ImageBuf(oiio.ImageSpec (<span class="hljs-number">3693</span>, <span class="hljs-number">2077</span>, <span class="hljs-number">3</span>, oiio.FLOAT))
oiio.ImageBufAlgo.paste(extended, <span class="hljs-number">0</span>, <span class="hljs-number">253</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, cropped)

<span class="hljs-comment"># Create a new buffer, resize the extended image to 1920x1080 and add some text</span>
resized = oiio.ImageBuf(oiio.ImageSpec (<span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">3</span>, oiio.FLOAT))
oiio.ImageBufAlgo.resize(resized, extended)
oiio.ImageBufAlgo.render_text(resized, <span class="hljs-number">1300</span>, <span class="hljs-number">1030</span>, <span class="hljs-string">"00066.cr2"</span>, <span class="hljs-number">50</span>, <span class="hljs-string">"Arial"</span>)
oiio.ImageBufAlgo.render_text(resized, <span class="hljs-number">1600</span>, <span class="hljs-number">1030</span>, <span class="hljs-string">"00:00:02:18"</span>, <span class="hljs-number">50</span>, <span class="hljs-string">"Arial"</span>)
resized.write(<span class="hljs-string">"final.jpg"</span>)</code></pre></div><p>THat ultimately takes the following lovely shot of a dino from RAW form to that with extended borders and burnt in information.</p>
<p><img src="http://ianwootten.co.uk/images/Dino_001_01_X1_0066_original.jpg" title="Original RAW" /></p>
<p><img src="http://ianwootten.co.uk/images/dino-final.jpg" title="Processed image with metadata" /></p>
<p>What&#39;s great about this is that we&#39;ve used a single library to perform this series of transformations and we&#39;ve not had to break out to use commandline operations to do so, instead manipulating them from the comfort of python.</p>
<h2 id="chaining-commands">Chaining commands</h2>
<p>From using various javascript libraries (jQuery, Underscore), I&#39;ve become used to the simplicity of being able to quickly chain a whole bunch of commands together. For that reason, I wrapped a number of the OpenImageIO ImageBufAlgo methods up into a single class OiioChain so that it&#39;s possible to perform the same set of above transformations using a somewhat more concise syntax. You can find it <a href="https://github.com/framepipe/OiioChain">on github</a>.</p>
<div class='hljs'><pre><code class='python'><span class="hljs-keyword">from</span> oiio_chain <span class="hljs-keyword">import</span> OiioChain

chain = OiioChain(<span class="hljs-string">"Dino_001_01_X1_0066.cr2"</span>)

chain.crop(<span class="hljs-number">1208</span>, <span class="hljs-number">4901</span>, <span class="hljs-number">814</span>, <span class="hljs-number">2385</span>)\
    .extend(<span class="hljs-number">3693</span>, <span class="hljs-number">2077</span>).resize(<span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>)\
    .text(<span class="hljs-number">1300</span>, <span class="hljs-number">1030</span>, <span class="hljs-string">"00066.cr2"</span>).text(<span class="hljs-number">1600</span>, <span class="hljs-number">1030</span>, <span class="hljs-string">"00:00:02:18"</span>)\
    .write(<span class="hljs-string">"final.jpg"</span>)</code></pre></div><h1 id="displaying-images-with-image-viewer">Displaying Images with Image Viewer</h1>
<p>OpenImageIO even comes with it&#39;s own built in image viewer, to handle quick display of images or to incorporate viewing capabilities into your own software. You can access this from the terminal by using the executable &quot;iv&quot;.</p>
<p><img src="http://ianwootten.co.uk/images/screen_shot-15-09-2014.png" title="Image Viewer" /></p>
<p>I&#39;m really enjoying experimenting with OpenImageIO and am currently experimenting putting it into a service which performs on demand storage and transformation of media which I&#39;ll write about further at a later date. Currently, there&#39;s no means of being able to process stills into videos, for which further tools would be required, but I&#39;ve heard word that work is ongoing to implement libav capabilities.</p>
<p>There&#39;s such a huge amount that&#39;s possible with the library which I&#39;ve not covered and it should definitely be at the top of your list if you&#39;re looking at handling RAW media for your own projects.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/openimageio">openimageio</a>,
                
                <a href="/tag/python">python</a>,
                
              
              | <a href="2014/09/15/processing-camera-raws-with-openimageio-and-python/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2014/07/31/extracting-shot-thumbnails-from-a-video-using-ffmpeg">Extracting Shot Thumbnails from a video using FFMPEG</a></h1>
      <div class="author_meta">31 Jul 2014</div>

          <p>Recently, Andy Davies asked the following question on twitter:</p>
<p><blockquote class="twitter-tweet" data-partner="tweetdeck"><p>Any ideas on how I can easily convert a video to a filmstrip?</p>&mdash; Andy Davies (@AndyDavies) <a href="https://twitter.com/AndyDavies/statuses/491878215464808450">July 23, 2014</a></blockquote></p>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>I found this pretty interesting, especially given I&#39;d used various open source tools for assembling storyboards in the past. I knew it was possible to extract images at desired intervals and left it as that.</p>
<p>After a bit of digging last night, I discovered it&#39;s <a href="http://superuser.com/questions/538112/meaningful-thumbnails-for-a-video-using-ffmpeg">actually possible to extract images based on changes in the video</a>. We can use this to extract a rough approximation to individual shots.</p>
<p>I&#39;ve run the following command on the Big Buck Bunny in order to extract 138 individual changes from the 10 min short. I&#39;m using ffmpeg version 2.3 (I had tried using ffmbc 0.7, but it is unable to parse some of the options).</p>
<div class='hljs'><pre><code class='bash'>ffmpeg -ss <span class="hljs-number">3</span> -i big_buck_bunny_1080p_surround.avi -vf <span class="hljs-string">"select=gt(scene\,0.2)"</span> -vsync vfr <span class="hljs-operator">-s</span> vga <span class="hljs-operator">-f</span> image2 out%<span class="hljs-number">02</span>d.jpg</code></pre></div><p>The real gold here is the &#39;-vf &quot;select=gt(scene\,0.2)&quot;&#39;, which grabs scene changes based on a difference in the frame of 20% or more. There are certain discrepancies in a couple of shots, but in the main this method works well and quickly. I specify the output format (-f) and size (-s) so that I can get small thumbs rather than the 1920x1080 the short is in.</p>
<p>You can see how well this performs through the selections made for the first 10 changes shown below.</p>
<p><img src="http://ianwootten.co.uk/images/ffmpeg-board-sample.jpg" title="Sample ffmpeg scene changes" /></p>
<p>In order to assemble the thumbs into an individual image I&#39;ve used the <a href="http://www.imagemagick.org/Usage/montage/">&quot;montage&quot;</a> command from imagemajick.</p>
<div class='hljs'><pre><code class='bash'>montage *.jpg -geometry 320x180+2+2 -tile 3x4 sample.jpg</code></pre></div><p>This assembles the images in the current directory in a 3x4 grid and outputs them to sample.jpg. If there are more images that will fit in a 3x4 grid, multiple output images will be created to represent the strip.</p>
<p>Animation is a really good exemplar for this technique, probably due to the obvious changes between each shot. However I can imagine it would fare less well with say a live action feature, where scene changes may be more gradual and/or lighting is more subtle.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/imagemajick">imagemajick</a>,
                
                <a href="/tag/ffmpeg">ffmpeg</a>,
                
              
              | <a href="2014/07/31/extracting-shot-thumbnails-from-a-video-using-ffmpeg/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      

      <div class="pagination">
          
          <span class="page_number ">Page: 1 of 57</span>

          
          <a href="/page/2" class="next">Next</a>
          
      </div>
    <footer>
      <div class="footer-about">
        I'm a Web Developer  working at <a href="http://niftydigits.com">Nifty Digits</a> in Cardiff, UK. Here, I enjoy talking code - mostly javascript. I'm <a href="http://twitter.com/iwootten">@iwootten</a> on twitter.
      </div>
    </footer>
  </div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ianwootten'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
</body>
</html>

