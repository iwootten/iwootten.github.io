<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Ian Wootten - Web Developer, Cardiff</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fonts/open-sans.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-263865-2', 'ianwootten.co.uk');
      ga('send', 'pageview');

    </script>
</head>
<body>

<div class="container blog">
    <header>
      <nav>
      <ul class="nav">
        <li><a class="blog active" href="/">Blog</a></li>
        <li><a class="javascript " href="/category/javascript">Javascript</a></li>
        <li><a class="web-apps " href="/category/web-apps">Web Apps</a></li>
        <li><a class="about" href="/about">About</a></li>
        <li><a class="contact" href="/contact">Contact</a></li>
      </ul>
      </nav>
      <div class="clear"></div>
    </header>

      
        <div class="post">
          <h1><a href="/2011/11/02/pagination-in-couchdb-apps">Pagination in CouchDB Apps</a></h1>
      <div class="author_meta">02 Nov 2011</div>

          <p>I&#8217;ve been working on some fun little node.js / couchdb projects of late. Given the fact I don&#8217;t use either as part of my work, I&#8217;ve spent some downtime experimenting and slowly iterating my approaches as I learn best practice.</p>
<p>I hit what I consider to be a fairly frustrating hurdle that couchdb threw up that I&#8217;ve been blissfully unaware of through all my couchdb dev. When it came to doing pagination it turns out <a href="http://guide.couchdb.org/draft/recipes.html#pagination" title="CouchDB Pagination Recipe">I&#8217;ve always been doing it the &#8220;bad&#8221; way</a>. Oh, well that&#8217;s upsetting.</p>
<h2 id="the-wrong-way">The Wrong Way</h2>
<p>My &#8220;slow&#8221; approach has always been to take the page no as a argument in the url, generating &#8220;skip&#8221; and &#8220;limit&#8221; variables to be used as parameters to my store. So for example, if I wanted to have the 2nd page of my app showing 10 items:</p>
<div class='hljs'><pre><code class='javascript'>  <span class="hljs-keyword">var</span> skip = (pageno==<span class="hljs-number">1</span>) ? () : ((pageno-<span class="hljs-number">1</span>) * <span class="hljs-number">10</span>);</code></pre></div><div class='hljs'><pre><code class='bash'>  curl -X GET http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5984</span>/stuff/_design/stuff/_view/by-name?skip=<span class="hljs-number">10</span>&amp;<span class="hljs-built_in">limit</span>=<span class="hljs-number">10</span></code></pre></div><p>It turns out, that although you might think you&#8217;re starting at a particular result, CouchDB still starts at the first result, due to the way the view is created from the b-tree index, couchDB just surpresses the results you skip. This isn&#8217;t good news when you&#8217;re trying to skip say, 10000 results.</p>
<h2 id="the-suggested-way">The Suggested Way</h2>
<p>The suggested solution is to perform requests and instead of using a &#8220;skip&#8221; parameter, keep track of the startkey at which the next page begins. This is possible, by requesting a page 1 item longer than that of the number of items on a page and using the key of the result in any requests. So now, for a first page my query is:</p>
<div class='hljs'><pre><code class='bash'>  curl -X GET http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5984</span>/stuff/_design/stuff/_view/by-name?<span class="hljs-built_in">limit</span>=<span class="hljs-number">11</span></code></pre></div><p>Returning something like:</p>
<div class='hljs'><pre><code class='json'> {"<span class="hljs-attribute">total_rows</span>":<span class="hljs-value"><span class="hljs-number">17</span></span>,"<span class="hljs-attribute">offset</span>":<span class="hljs-value"><span class="hljs-number">0</span></span>,"<span class="hljs-attribute">rows</span>":<span class="hljs-value">[
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"8177bf155b952652129836a5d354b30e"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Ian Wootten"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"bae2c490c70480aec7096d79e1e3bfc3"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Isambard Kingdom Brunel"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"eaae74cfbe5cd13ea6b50dfd090827ca"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Christopher Columbus"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"491e68b08d73256f060ebf4b8e063e1c"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Elizabeth Fry"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"b45d8a7b9edee9ca66ac0860196f4504"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Edward Jenner"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"8a4d3f46885701ffcc7532aeac7a5ae9"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Florence Nightingale"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"71e6534c17429eca2cd9450cfc95c6bb"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Samuel Pepys"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"6cbad847f0ae959b281b471a72d60587"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Pocahontas"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"e5b026ec5c92c20f1575a2901defe14e"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Mary Seacole"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"84a371a7b8414237fad1b6aaf68cd16a"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"George Stephenson"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"321aeb36e20d62660eb0d03c9fcd27b2"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Joe Bloggs"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>}
]</span>}</code></pre></div><p>From the 11th returned result, I have the key &#8220;Joe Bloggs&#8221; &#8211; which can be used as a startkey arg to couch to obtain my second page. If we have duplicate keys, it is also neccessary to keep tabs on the last document&#8217;s id and supply as a startkey_docid arg in order to correctly page through everything.</p>
<p>What personally I dislike about the suggested approach, is the inability to create simple requests to arbritrary pages, even with low numbers. We always need to follow a path of links from the first page in order to view particular results. CouchDB&#8217;s response is &#8220;Not even Google is doing that!&#8221;, which is kind of weak to me. I want nice clean urls ala myapp.com/page/2 or myapp.com?page=2.</p>
<p>In fact, such a suggested approach only really allows us to have a single &#8220;more&#8221; type link in order to fetch results. Passing a startkey as part of a url param eg /page/321aeb36e20d62660eb0d03c9fcd27b2 just sounds (and looks) plain nasty and isn&#8217;t very good from a UX point of view for any users we may have.</p>
<p>At the moment, clean tangible page urls (the right way) are only possible using custom middleware. I&#8217;ve yet to find anything suitable for <a href="http://nodejs.org">node.js</a>. I intend to investigate how to cache document keys for low numbered pages as a separate db in order to produce a solution for my current project and I hope to write a later post detailing how I&#8217;ve got on.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/articles">articles</a>,
                
                <a href="/tag/couchdb">couchdb</a>,
                
                <a href="/tag/nodejs">nodejs</a>,
                
              
              | <a href="2011/11/02/pagination-in-couchdb-apps/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2011/09/09/hosting-an-octopress-blog-on-amazon-s3">Hosting an Octopress Blog on Amazon S3</a></h1>
      <div class="author_meta">09 Sep 2011</div>

          <p><a href="http://octopress.org">Octopress</a> is a framework for blogging based on the static site generator <a href="https://github.com/mojombo/jekyll">jekyll</a>. In short jekyll takes markdown and turns it into blog style html ready to be served straight away with Apache whilst Octopress dresses it up nicely with HTML5, responsive layout goodness and gives you a bunch of options for code formatting and the like. A perfect little blogging setup for hackers for those of us who typically won&#8217;t need all the bells and whistles on our blog I&#8217;m sure you&#8217;ll agree.</p>
<p>Using Octopress, you&#8217;d typically write your posts in markdown and process them locally. You&#8217;d then have a number of HTML pages to upload to your web server, which would appear no different than any other blog in terms of functionality.</p>
<p>The most interesting thing that coincincides with the creation of jekyll is that it is now possible to serve static websites straight from Amazon S3, meaning that it isn&#8217;t neccessary to have a web server to serve a Octopress blog. I&#8217;ve been playing a little and have been able to serve my own octopress blog which you can see over at <a href="http://www.ianwootten.com">www.ianwootten.com</a>. Here&#8217;s how to do it:</p>
<h2 id="configure-an-s3-bucket-to-act-as-a-website">Configure an S3 Bucket to Act as a Website</h2>
<p>NB: If you want to use your own domain, then you&#8217;re going to need to create an S3 bucket from the AWS Console named the same as your domain (so for me I created a bucket called &#8220;www.ianwootten.com&#8221;. </p>
<p>To configure your bucket as a website, from the AWS Console, select the new bucket and click &#8220;Properties&#8221;. Choose the &#8220;Website&#8221; tab from the box that appears and check &#8220;enabled&#8221; and set the Index document as &#8220;index.html&#8221;. Click &#8220;Save&#8221;. Now move to the &#8220;permissions&#8221; tab and click &#8220;Add bucket policy&#8221;. Enter a policy as below, with &#8220;www.ianwootten.com&#8221; replaced with the name of the bucket you&#8217;re using.</p>
<p><code>&lt;br /&gt;
{&lt;br /&gt;
    &quot;Version&quot;: &quot;2008-10-17&quot;,&lt;br /&gt;
    &quot;Id&quot;: &quot;&quot;,&lt;br /&gt;
    &quot;Statement&quot;: [&lt;br /&gt;
        {&lt;br /&gt;
            &quot;Sid&quot;: &quot;PublicReadForGetBucketObjects&quot;,&lt;br /&gt;
            &quot;Effect&quot;: &quot;Allow&quot;,&lt;br /&gt;
            &quot;Principal&quot;: {&lt;br /&gt;
                &quot;AWS&quot;: &quot;*&quot;&lt;br /&gt;
            },&lt;br /&gt;
            &quot;Action&quot;: &quot;s3:GetObject&quot;,&lt;br /&gt;
            &quot;Resource&quot;: &quot;arn:aws:s3:::www.ianwootten.com/*&quot;&lt;br /&gt;
        }&lt;br /&gt;
    ]&lt;br /&gt;
}&lt;br /&gt;</code></p>
<p>If you&#8217;ve opted not to use your own domain, then that&#8217;s it for S3. Your new bucket website will be available at a combination of the bucket name and the S3 storage location. In my case, this is <a href="http://www.ianwootten.com.s3-website-us-east-1.amazonaws.com/">http://www.ianwootten.com.s3-website-us-east-1.amazonaws.com/</a>. There&#8217;s a list of endpoints on the &#8220;website endpoints&#8221; page in <a href="http://docs.amazonwebservices.com/AmazonS3/latest/dev/index.html?WebsiteHosting.html">Amazons S3 website docs</a>.</p>
<h2 id="configure-dns">Configure DNS</h2>
<p>If you&#8217;re wanting to use your own domain, then you&#8217;ll need to visit your domain registraar and edit some DNS entries. In my case, I added a CNAME entry &#8220;www&#8221; pointing to www.ianwootten.com.s3-website-us-east-1.amazonaws.com. You&#8217;ll need to use a tool like <a href="http://wwwizer.com">wwwizer</a> in order to forward from the root of your domain to the www subdomain. e.g. &#8220;ianwootten.com&#8221; to &#8220;www.ianwootten.com&#8221;. To get that working, you&#8217;ll also need to modify the @ A record and point it to 174.129.25.170. Read this <a href="http://serverfault.com/questions/62527/how-to-create-a-cname-for-a-domains-root-name">serverfault post</a> if you&#8217;re interested to know why.</p>
<p>For more info on CNAME configuration and S3 see <a href="http://docs.amazonwebservices.com/AmazonS3/latest/dev/index.html?WebsiteHosting.html">Amazons S3 website docs</a> (Specifically the notes on virtual hosting).</p>
<h2 id="download-octopress-and-write-some-markdown">Download Octopress and write some Markdown</h2>
<p>Having successfully configured Amazon S3 to host your blog, you need to tackle the age old problem of writing some content for it. This was particularly hard for me, given my lack of knowledge about markdown! You may like to take a look at <a href="http://daringfireball.net/projects/markdown/basics">John Grubers explanation of markdown</a> if you&#8217;re suffering like me. The <a href="http://octopress.org/docs/blogging/">Octopress blogging basics</a> gives a good overview of how your new local blogging workflow will work. Essentially new posts are written in the ./_source/posts folder and when <code>rake generate</code> is executed, your entire websites content is output to the ./public folder. You can also run <code>rake preview</code> in order to preview on a local server.</p>
<p>TO publish your blog, it&#8217;s merely a matter of transferring your /public content to the S3 bucket you&#8217;ve generated.</p>
<p>Having done all that you&#8217;ve now no need to run your own server. You&#8217;re still dependent on those that operate at S3, wwwizer and your domain registraar, but you&#8217;ve removed your own from the equation. You may be interested in checking out <a href="http://www.jerome-bernard.com/blog/2011/08/20/quick-tip-for-easily-deploying-octopress-blog-on-amazon-s3/">Jerome Bernard&#8217;s</a> tip on easily deploying Octopress blogs with <a href="http://s3tools.org/s3cmd">s3cmd</a>.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/amazon">amazon</a>,
                
                <a href="/tag/blog">blog</a>,
                
                <a href="/tag/blogging">blogging</a>,
                
                <a href="/tag/godaddy">godaddy</a>,
                
                <a href="/tag/jekyll">jekyll</a>,
                
                <a href="/tag/octopress">octopress</a>,
                
                <a href="/tag/s3">s3</a>,
                
              
              | <a href="2011/09/09/hosting-an-octopress-blog-on-amazon-s3/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2011/07/20/lovefilm-filmstream-plugin-v0-2">Lovefilm Filmstream Plugin v0.2</a></h1>
      <div class="author_meta">20 Jul 2011</div>

          <p>Just a quick note to say I&#8217;ve updated the plugin that generates my <a href="http://ianwootten.co.uk/filmstream">filmstream pages</a>. It&#8217;s become obvious that the <a href="http://developer.lovefilm.com">Lovefilm API</a> only exposes the last 10 features that you&#8217;ve rented in their &#8220;at home&#8221; list. This isn&#8217;t that great if you&#8217;ve been renting more than a few months. This is the same as the information you&#8217;d see in your account when logged in.</p>
<p>I&#8217;ve made a simple modification to use the actual ids that <a href="http://lovefilm.com">Lovefilm</a> issue for films, rather than a autoincrement value. This way, there&#8217;s no need to empty what&#8217;s currently stored when updating and we capture the users history of rentals&#8230;</p>
<p>You can grab it over <a href="http://www.ianwootten.co.uk/downloads/filmstream.zip">here</a></p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/lovefilm">lovefilm</a>,
                
                <a href="/tag/plugins">plugins</a>,
                
              
              | <a href="2011/07/20/lovefilm-filmstream-plugin-v0-2/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2011/07/14/participate-don-t-preach">Participate, Don’t Preach</a></h1>
      <div class="author_meta">14 Jul 2011</div>

          <p>Last week, tickets went on sale for dConstruct 2011 and sold out within an impressive 7 hours. Having attended in 2010 and 2008 and judging it to be filled with the highest calibre web celebs from across the globe, I coughed up the entrance fee as part of the excited gold-rush. The cost of £150 includes access to the pre and after parties and the conference itself.</p>
<p>These type of events are stuffed to the brim with amazing, intelligent web professionals, many of whom I would consider to be colleagues. I’ve followed their progress, listened to them speak, bought their publications and hacked on code with them at many other previous events.</p>
<p>It’s often quoted within tech circles that the best parts of these events are not the talks themselves, but the networking parties that surround them. I really struggle in these environments, nervously trying to find a crowd I feel comfortable chatting with, introducing myself and trying to strike up some cutting edge debate on the topics of the day. I’m a developer who usually lurks behind a computer screen for 8 hours a day, so why wouldn’t I find it awkward? It feels like uncharted territory every time I find myself there. Although meeting some great, interesting people, I have ultimately never forged any new lasting relations in this way, where the interaction is somewhat forced and artificial. Maybe it’s just me, but given the com mon nature of everyones work, you’d think it might be easier. As a friend once observed &#8211; it’s like everyone turns up to sell their product, but there are no buyers.</p>
<p>It’s also great to be able to chat within the inner circle of the celebrities who attend. You’ve heard from them all year round and now have a brief opportunity to chat. I guess really I’d love to bounce questions and thoughts off of these guys all evening, but often I get the feeling I’m being evaluated against the rest of the attendees in the room in terms of worthiness. Until you’re edging<br>into such circles yourself, I’m not entirely sure what they would get from these conversations either.</p>
<p>In fact, what I have found is that my most fruitful and long lasting relations have been founded at events when in a participatory nature. Most of these have been Hack Days (where you’re invited to quickly hack together software as an exemplar of new apis from a number of vendors) and some of them have been at Bar Camps (where all attendees have to speak on a subject close to their heart). I feel closer to these people than I could ever do with someone I spoke with briefly in a noisy bar. I’ll also remember faces and names of people even if I never had the chance to interact with them.</p>
<p>This year, a new variety of geek meet has arisen, which flip these more traditional events on their heads and instead focus on providing environments that focus on “the best bits”. They allow everyone to participate on level pegging rather than follow a traditional conference structure. Earlier this month there was <a href=“http://geekkart.in”>Geek Karting</a>, <a href=“http://insitestour.com”>The Insites Tour</a> is kicking off next week and later this year there’s <a href=“http://preparetoactivate.com”>Activate</a>. I really like the idea of these as a way of sparking interesting relationships and I’m hopefully going to head to Insites next week to see what Elliot and Keir have been able to cook up. I’d hope to see more of these unusual types of event and ultimately participate in more of them.</p>
<p>I still feel that conferences have their place, otherwise I wouldn’t have coughed up the fee for dConstruct. I enjoy hearing what these illustrious speakers have to say. That part of the event is still important for sparking debate and learning from for months and years afterward. However, I just don’t find surrounding parties as valuable to me as I first would have thought.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/dConstruct">dConstruct</a>,
                
                <a href="/tag/events">events</a>,
                
                <a href="/tag/hacking">hacking</a>,
                
                <a href="/tag/Web">Web</a>,
                
              
              | <a href="2011/07/14/participate-don-t-preach/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2011/07/04/maintaining-references-to-sockets-with-express-and-socket-io">Maintaining References to Sockets with Express and Socket.io</a></h1>
      <div class="author_meta">04 Jul 2011</div>

          <p>I hit a frustrating problem when trying to use expressjs alongside <a href="http://socket.io">socket.io</a> recently. The solution may seem somewhat trivial, but I struggled with it for a while, until finally asking for help on the <a href="http://socket.io">socket.io</a> irc channel. I&#8217;m not sure if a better solution exists for my case, but this is what I have for now.</p>
<p>In the main route of my express app, I needed to iterate across an array, performing a REST call using each element as a parameter and spit the results back for socket.io to send out to the browser. To get some idea of what that would look like, imagine the following.</p>
<div class='hljs'><pre><code class='javascript'>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &amp;lt; someArray.length; i++){
   <span class="hljs-keyword">var</span> someVariable = doSomething(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>)</span>{
     socket.emit(<span class="hljs-string">'msg'</span>, results);
  });
  }
});</code></pre></div><p>My problem then became, how do I emit in this way, given my use case? All examples I could find on the <a href="http://socket.io">socket.io</a> homepages demonstrate emitting msgs on connection, like this:</p>
<div class='hljs'><pre><code class='javascript'>io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
  <span class="hljs-comment">// send custom events to browser socket</span>
  socket.emit(<span class="hljs-string">'hi'</span>, { <span class="hljs-string">'i can send'</span>: <span class="hljs-string">'json!'</span> });
});</code></pre></div><p>But I wanted to emit messages as part of a loop, within an app route. How would I do that? I could wrap the loop with the connection logic:</p>
<div class='hljs'><pre><code class='javascript'>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
  io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &amp;lt; someArray.length; i++){
      <span class="hljs-keyword">var</span> someVariable = doSomething(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>)</span>{
         socket.emit(<span class="hljs-string">'msg'</span>, results);
      });
    }
  });
});</code></pre></div><p>But if I do this, then my connection listener would be added on every refresh of the route. This would mean I&#39;d end up with duplicate binding of event listeners and a load more results messages would be emitted than I&#39;d expect. This would result in crazy behavior for any user who might choose to refresh your app.</p>
<p>Actually, the solution is rather simple although not entirely obvious given the nature of using node. If you maintain a reference to the socket as a global variable and then later emit upon that same socket, like so:</p>
<div class='hljs'><pre><code class='javascript'><span class="hljs-keyword">var</span> global_socket;

io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
  global_socket = socket;
});

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &amp;lt; someArray.length; i++){
    <span class="hljs-keyword">var</span> someVariable = doSomething(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>)</span>{
      global_socket.emit(<span class="hljs-string">'msg'</span>, results);
    });
  }
});</code></pre></div><p>This way, a connection will be established and maintained and we won&#39;t get duplicate bindings when refreshing the route of the app. Simple when you know how. I had a rather interesting discussion following this on irc about whether the use of express and socket.io together is warranted, given that socket.io supports use of variable passing and ultimately could entirely replace an express app.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/express">express</a>,
                
                <a href="/tag/expressjs">expressjs</a>,
                
                <a href="/tag/node">node</a>,
                
                <a href="/tag/nodejs">nodejs</a>,
                
                <a href="/tag/socket.io">socket.io</a>,
                
              
              | <a href="2011/07/04/maintaining-references-to-sockets-with-express-and-socket-io/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      

      <div class="pagination">
          
          <span class="page_number ">Page: 1 of 2</span>

          
          <a href="/2011/page/2" class="next">Next</a>
          
      </div>
    <footer>
      <div class="footer-about">
        I'm a Web Developer  working at <a href="http://niftydigits.com">Nifty Digits</a> in Cardiff, UK. Here, I enjoy talking code - mostly Python/Javascript. I'm <a href="http://twitter.com/iwootten">@iwootten</a> on twitter.
      </div>
    </footer>
  </div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ianwootten'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
</body>
</html>

