<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Ian Wootten - Web Developer, Cardiff</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fonts/open-sans.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-263865-2', 'ianwootten.co.uk');
      ga('send', 'pageview');

    </script>
</head>
<body>

<div class="container blog">
    <header>
      <nav>
      <ul class="nav">
        <li><a class="blog active" href="/">Blog</a></li>
        <li><a class="javascript " href="/category/javascript">Javascript</a></li>
        <li><a class="web-apps " href="/category/web-apps">Web Apps</a></li>
        <li><a class="about" href="/about">About</a></li>
        <li><a class="contact" href="/contact">Contact</a></li>
      </ul>
      </nav>
      <div class="clear"></div>
    </header>

      
        <div class="post">
          <h1><a href="/2011/11/02/pagination-in-couchdb-apps">Pagination in CouchDB Apps</a></h1>
      <div class="author_meta">02 Nov 2011</div>

          <p>I&#8217;ve been working on some fun little node.js / couchdb projects of late. Given the fact I don&#8217;t use either as part of my work, I&#8217;ve spent some downtime experimenting and slowly iterating my approaches as I learn best practice.</p>
<p>I hit what I consider to be a fairly frustrating hurdle that couchdb threw up that I&#8217;ve been blissfully unaware of through all my couchdb dev. When it came to doing pagination it turns out <a href="http://guide.couchdb.org/draft/recipes.html#pagination" title="CouchDB Pagination Recipe">I&#8217;ve always been doing it the &#8220;bad&#8221; way</a>. Oh, well that&#8217;s upsetting.</p>
<h2 id="the-wrong-way">The Wrong Way</h2>
<p>My &#8220;slow&#8221; approach has always been to take the page no as a argument in the url, generating &#8220;skip&#8221; and &#8220;limit&#8221; variables to be used as parameters to my store. So for example, if I wanted to have the 2nd page of my app showing 10 items:</p>
<div class='hljs'><pre><code class='javascript'>  <span class="hljs-keyword">var</span> skip = (pageno==<span class="hljs-number">1</span>) ? () : ((pageno-<span class="hljs-number">1</span>) * <span class="hljs-number">10</span>);</code></pre></div><div class='hljs'><pre><code class='bash'>  curl -X GET http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5984</span>/stuff/_design/stuff/_view/by-name?skip=<span class="hljs-number">10</span>&amp;<span class="hljs-built_in">limit</span>=<span class="hljs-number">10</span></code></pre></div><p>It turns out, that although you might think you&#8217;re starting at a particular result, CouchDB still starts at the first result, due to the way the view is created from the b-tree index, couchDB just surpresses the results you skip. This isn&#8217;t good news when you&#8217;re trying to skip say, 10000 results.</p>
<h2 id="the-suggested-way">The Suggested Way</h2>
<p>The suggested solution is to perform requests and instead of using a &#8220;skip&#8221; parameter, keep track of the startkey at which the next page begins. This is possible, by requesting a page 1 item longer than that of the number of items on a page and using the key of the result in any requests. So now, for a first page my query is:</p>
<div class='hljs'><pre><code class='bash'>  curl -X GET http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5984</span>/stuff/_design/stuff/_view/by-name?<span class="hljs-built_in">limit</span>=<span class="hljs-number">11</span></code></pre></div><p>Returning something like:</p>
<div class='hljs'><pre><code class='json'> {"<span class="hljs-attribute">total_rows</span>":<span class="hljs-value"><span class="hljs-number">17</span></span>,"<span class="hljs-attribute">offset</span>":<span class="hljs-value"><span class="hljs-number">0</span></span>,"<span class="hljs-attribute">rows</span>":<span class="hljs-value">[
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"8177bf155b952652129836a5d354b30e"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Ian Wootten"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"bae2c490c70480aec7096d79e1e3bfc3"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Isambard Kingdom Brunel"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"eaae74cfbe5cd13ea6b50dfd090827ca"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Christopher Columbus"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"491e68b08d73256f060ebf4b8e063e1c"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Elizabeth Fry"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"b45d8a7b9edee9ca66ac0860196f4504"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Edward Jenner"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"8a4d3f46885701ffcc7532aeac7a5ae9"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Florence Nightingale"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"71e6534c17429eca2cd9450cfc95c6bb"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Samuel Pepys"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"6cbad847f0ae959b281b471a72d60587"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Pocahontas"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"e5b026ec5c92c20f1575a2901defe14e"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Mary Seacole"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"84a371a7b8414237fad1b6aaf68cd16a"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"George Stephenson"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"321aeb36e20d62660eb0d03c9fcd27b2"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Joe Bloggs"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>}
]</span>}</code></pre></div><p>From the 11th returned result, I have the key &#8220;Joe Bloggs&#8221; &#8211; which can be used as a startkey arg to couch to obtain my second page. If we have duplicate keys, it is also neccessary to keep tabs on the last document&#8217;s id and supply as a startkey_docid arg in order to correctly page through everything.</p>
<p>What personally I dislike about the suggested approach, is the inability to create simple requests to arbritrary pages, even with low numbers. We always need to follow a path of links from the first page in order to view particular results. CouchDB&#8217;s response is &#8220;Not even Google is doing that!&#8221;, which is kind of weak to me. I want nice clean urls ala myapp.com/page/2 or myapp.com?page=2.</p>
<p>In fact, such a suggested approach only really allows us to have a single &#8220;more&#8221; type link in order to fetch results. Passing a startkey as part of a url param eg /page/321aeb36e20d62660eb0d03c9fcd27b2 just sounds (and looks) plain nasty and isn&#8217;t very good from a UX point of view for any users we may have.</p>
<p>At the moment, clean tangible page urls (the right way) are only possible using custom middleware. I&#8217;ve yet to find anything suitable for <a href="http://nodejs.org">node.js</a>. I intend to investigate how to cache document keys for low numbered pages as a separate db in order to produce a solution for my current project and I hope to write a later post detailing how I&#8217;ve got on.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/articles">articles</a>,
                
                <a href="/tag/couchdb">couchdb</a>,
                
                <a href="/tag/nodejs">nodejs</a>,
                
              
              | <a href="2011/11/02/pagination-in-couchdb-apps/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      

      <div class="pagination">
          
          <span class="page_number ">Page: 1 of 1</span>

          
      </div>
    <footer>
      <div class="footer-about">
        I'm a Web Developer  working at <a href="http://niftydigits.com">Nifty Digits</a> in Cardiff, UK. Here, I enjoy talking code - mostly javascript. I'm <a href="http://twitter.com/iwootten">@iwootten</a> on twitter.
      </div>
    </footer>
  </div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ianwootten'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
</body>
</html>

