<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Ian Wootten - Web Developer, Cardiff</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fonts/open-sans.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-263865-2', 'ianwootten.co.uk');
      ga('send', 'pageview');

    </script>
</head>
<body>

<div class="container javascript">
    <header>
      <nav>
      <ul class="nav">
        <li><a class="blog " href="/">Blog</a></li>
        <li><a class="javascript active" href="/category/javascript">Javascript</a></li>
        <li><a class="web-apps " href="/category/web-apps">Web Apps</a></li>
        <li><a class="about" href="/about">About</a></li>
        <li><a class="contact" href="/contact">Contact</a></li>
      </ul>
      </nav>
      <div class="clear"></div>
    </header>

      
        <div class="post">
          <h1><a href="/2012/11/23/oh-crap-i-m-a-frontend-developer">Oh Crap, I&#39;m a Frontend Developer</a></h1>
      <div class="author_meta">23 Nov 2012</div>

          <p>When I was first tiptoeing in the waters of web development (early 2000&#8242;s), getting a grips on job descriptions was simple. There were 2 types of people in our industry: designers or developers. You either drew websites, or you built websites &#8211; that was it.</p>
<p>As time went on people seemed to invent new titles: &#8220;UX Designers&#8221; were the first to appear on the scene to me, and <a href="http://adactio.com/journal/1596">we&#8217;re still to this day figuring out what this role really entails</a>. The one that particularly got my hair up though was a &#8220;Frontend Developer&#8221;. Basically, going from the skills that were listed with these roles (HTML, CSS, JS) it was a designer who could also do a bit of jQuery…. Not a real developer then. Not someone who pokes around with backend scripts and really knows what&#8217;s going on, right? Someone who can properly structure apps and create proper object oriented classes. It got my hair up because it seemed like an attempt to poach credentials from us hardworking devs. How dare they. Losers.</p>
<p>Time passed…. I got a real job….. The industry invented more job titles….</p>
<p>My first role was as a PHP/MySQL developer. I also started having to make decisions on frontend design and behaviour without having a formal education in either. I was, in my own projects at least, the only person to do such work. Outside of work during my first job, I decided to play with two hot technologies at the time: CouchDB and node.js. I geeked out about both, using document based stores and Javascript server-side &#8211; but hated the steep learning curve that came with having to use JS. It also missed many of the constructs I&#8217;d become used to in other languages.</p>
<p>I&#8217;d seen a great deal of realtime apps and knew behaviour in my own apps should be keeping up. What I had could be better, much better. It was about here I probably started appreciating how much work was involved in a typical browser based app. I started using <a href="http://backbonejs.org">backbone.js</a> with a view to better organising the mess of JS that typically sat next to my markup. There wasn&#8217;t a great deal of help around, so I read a book as an aide….. I had to properly approach what was going on in the browser as I would do any other software. Hmm, weird. JS in the browser had up until now, been an afterthought to &#8220;jazz stuff up&#8221;. Developing real, well designed software in the browser however really floated my boat. I prototyped a simple calendar app and it worked fantastically well.</p>
<p>Since then, I&#8217;ve been lucky enough to move into a full time contract role as a Javascript Developer &#8211; or a Frontend Web Developer, if you like. I probably would have been shocked had someone suggested this 5 or so years ago.</p>
<p>I&#8217;m really enjoying being part of the community around JS, the ever increasing list of libraries being posted and patterns for development. Hopefully I&#8217;ve learnt to be a little more discerning of job titles than I have been in the past.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/couchdb">couchdb</a>,
                
                <a href="/tag/js">js</a>,
                
                <a href="/tag/nodejs">nodejs</a>,
                
              
              | <a href="2012/11/23/oh-crap-i-m-a-frontend-developer/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2011/11/02/pagination-in-couchdb-apps">Pagination in CouchDB Apps</a></h1>
      <div class="author_meta">02 Nov 2011</div>

          <p>I&#8217;ve been working on some fun little node.js / couchdb projects of late. Given the fact I don&#8217;t use either as part of my work, I&#8217;ve spent some downtime experimenting and slowly iterating my approaches as I learn best practice.</p>
<p>I hit what I consider to be a fairly frustrating hurdle that couchdb threw up that I&#8217;ve been blissfully unaware of through all my couchdb dev. When it came to doing pagination it turns out <a href="http://guide.couchdb.org/draft/recipes.html#pagination" title="CouchDB Pagination Recipe">I&#8217;ve always been doing it the &#8220;bad&#8221; way</a>. Oh, well that&#8217;s upsetting.</p>
<h2 id="the-wrong-way">The Wrong Way</h2>
<p>My &#8220;slow&#8221; approach has always been to take the page no as a argument in the url, generating &#8220;skip&#8221; and &#8220;limit&#8221; variables to be used as parameters to my store. So for example, if I wanted to have the 2nd page of my app showing 10 items:</p>
<div class='hljs'><pre><code class='javascript'>  <span class="hljs-keyword">var</span> skip = (pageno==<span class="hljs-number">1</span>) ? () : ((pageno-<span class="hljs-number">1</span>) * <span class="hljs-number">10</span>);</code></pre></div><div class='hljs'><pre><code class='bash'>  curl -X GET http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5984</span>/stuff/_design/stuff/_view/by-name?skip=<span class="hljs-number">10</span>&amp;<span class="hljs-built_in">limit</span>=<span class="hljs-number">10</span></code></pre></div><p>It turns out, that although you might think you&#8217;re starting at a particular result, CouchDB still starts at the first result, due to the way the view is created from the b-tree index, couchDB just surpresses the results you skip. This isn&#8217;t good news when you&#8217;re trying to skip say, 10000 results.</p>
<h2 id="the-suggested-way">The Suggested Way</h2>
<p>The suggested solution is to perform requests and instead of using a &#8220;skip&#8221; parameter, keep track of the startkey at which the next page begins. This is possible, by requesting a page 1 item longer than that of the number of items on a page and using the key of the result in any requests. So now, for a first page my query is:</p>
<div class='hljs'><pre><code class='bash'>  curl -X GET http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5984</span>/stuff/_design/stuff/_view/by-name?<span class="hljs-built_in">limit</span>=<span class="hljs-number">11</span></code></pre></div><p>Returning something like:</p>
<div class='hljs'><pre><code class='json'> {"<span class="hljs-attribute">total_rows</span>":<span class="hljs-value"><span class="hljs-number">17</span></span>,"<span class="hljs-attribute">offset</span>":<span class="hljs-value"><span class="hljs-number">0</span></span>,"<span class="hljs-attribute">rows</span>":<span class="hljs-value">[
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"8177bf155b952652129836a5d354b30e"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Ian Wootten"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"bae2c490c70480aec7096d79e1e3bfc3"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Isambard Kingdom Brunel"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"eaae74cfbe5cd13ea6b50dfd090827ca"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Christopher Columbus"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"491e68b08d73256f060ebf4b8e063e1c"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Elizabeth Fry"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"b45d8a7b9edee9ca66ac0860196f4504"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Edward Jenner"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"8a4d3f46885701ffcc7532aeac7a5ae9"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Florence Nightingale"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"71e6534c17429eca2cd9450cfc95c6bb"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Samuel Pepys"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"6cbad847f0ae959b281b471a72d60587"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Pocahontas"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"e5b026ec5c92c20f1575a2901defe14e"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Mary Seacole"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"84a371a7b8414237fad1b6aaf68cd16a"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"George Stephenson"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>},
  {"<span class="hljs-attribute">id</span>":<span class="hljs-value"><span class="hljs-string">"321aeb36e20d62660eb0d03c9fcd27b2"</span></span>,"<span class="hljs-attribute">key</span>":<span class="hljs-value"><span class="hljs-string">"Joe Bloggs"</span></span>,"<span class="hljs-attribute">value</span>":<span class="hljs-value"><span class="hljs-literal">null</span></span>}
]</span>}</code></pre></div><p>From the 11th returned result, I have the key &#8220;Joe Bloggs&#8221; &#8211; which can be used as a startkey arg to couch to obtain my second page. If we have duplicate keys, it is also neccessary to keep tabs on the last document&#8217;s id and supply as a startkey_docid arg in order to correctly page through everything.</p>
<p>What personally I dislike about the suggested approach, is the inability to create simple requests to arbritrary pages, even with low numbers. We always need to follow a path of links from the first page in order to view particular results. CouchDB&#8217;s response is &#8220;Not even Google is doing that!&#8221;, which is kind of weak to me. I want nice clean urls ala myapp.com/page/2 or myapp.com?page=2.</p>
<p>In fact, such a suggested approach only really allows us to have a single &#8220;more&#8221; type link in order to fetch results. Passing a startkey as part of a url param eg /page/321aeb36e20d62660eb0d03c9fcd27b2 just sounds (and looks) plain nasty and isn&#8217;t very good from a UX point of view for any users we may have.</p>
<p>At the moment, clean tangible page urls (the right way) are only possible using custom middleware. I&#8217;ve yet to find anything suitable for <a href="http://nodejs.org">node.js</a>. I intend to investigate how to cache document keys for low numbered pages as a separate db in order to produce a solution for my current project and I hope to write a later post detailing how I&#8217;ve got on.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/articles">articles</a>,
                
                <a href="/tag/couchdb">couchdb</a>,
                
                <a href="/tag/nodejs">nodejs</a>,
                
              
              | <a href="2011/11/02/pagination-in-couchdb-apps/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2011/07/04/maintaining-references-to-sockets-with-express-and-socket-io">Maintaining References to Sockets with Express and Socket.io</a></h1>
      <div class="author_meta">04 Jul 2011</div>

          <p>I hit a frustrating problem when trying to use expressjs alongside <a href="http://socket.io">socket.io</a> recently. The solution may seem somewhat trivial, but I struggled with it for a while, until finally asking for help on the <a href="http://socket.io">socket.io</a> irc channel. I&#8217;m not sure if a better solution exists for my case, but this is what I have for now.</p>
<p>In the main route of my express app, I needed to iterate across an array, performing a REST call using each element as a parameter and spit the results back for socket.io to send out to the browser. To get some idea of what that would look like, imagine the following.</p>
<div class='hljs'><pre><code class='javascript'>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &amp;lt; someArray.length; i++){
   <span class="hljs-keyword">var</span> someVariable = doSomething(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>)</span>{
     socket.emit(<span class="hljs-string">'msg'</span>, results);
  });
  }
});</code></pre></div><p>My problem then became, how do I emit in this way, given my use case? All examples I could find on the <a href="http://socket.io">socket.io</a> homepages demonstrate emitting msgs on connection, like this:</p>
<div class='hljs'><pre><code class='javascript'>io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
  <span class="hljs-comment">// send custom events to browser socket</span>
  socket.emit(<span class="hljs-string">'hi'</span>, { <span class="hljs-string">'i can send'</span>: <span class="hljs-string">'json!'</span> });
});</code></pre></div><p>But I wanted to emit messages as part of a loop, within an app route. How would I do that? I could wrap the loop with the connection logic:</p>
<div class='hljs'><pre><code class='javascript'>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
  io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &amp;lt; someArray.length; i++){
      <span class="hljs-keyword">var</span> someVariable = doSomething(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>)</span>{
         socket.emit(<span class="hljs-string">'msg'</span>, results);
      });
    }
  });
});</code></pre></div><p>But if I do this, then my connection listener would be added on every refresh of the route. This would mean I&#39;d end up with duplicate binding of event listeners and a load more results messages would be emitted than I&#39;d expect. This would result in crazy behavior for any user who might choose to refresh your app.</p>
<p>Actually, the solution is rather simple although not entirely obvious given the nature of using node. If you maintain a reference to the socket as a global variable and then later emit upon that same socket, like so:</p>
<div class='hljs'><pre><code class='javascript'><span class="hljs-keyword">var</span> global_socket;

io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
  global_socket = socket;
});

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &amp;lt; someArray.length; i++){
    <span class="hljs-keyword">var</span> someVariable = doSomething(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>)</span>{
      global_socket.emit(<span class="hljs-string">'msg'</span>, results);
    });
  }
});</code></pre></div><p>This way, a connection will be established and maintained and we won&#39;t get duplicate bindings when refreshing the route of the app. Simple when you know how. I had a rather interesting discussion following this on irc about whether the use of express and socket.io together is warranted, given that socket.io supports use of variable passing and ultimately could entirely replace an express app.</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/express">express</a>,
                
                <a href="/tag/expressjs">expressjs</a>,
                
                <a href="/tag/node">node</a>,
                
                <a href="/tag/nodejs">nodejs</a>,
                
                <a href="/tag/socket.io">socket.io</a>,
                
              
              | <a href="2011/07/04/maintaining-references-to-sockets-with-express-and-socket-io/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      
        <div class="post">
          <h1><a href="/2011/02/07/blog-rolling-with-couchdb-express-and-node-js">Blog rolling with CouchDB, Express and Node.js</a></h1>
      <div class="author_meta">07 Feb 2011</div>

          <p>Over the last little while, I&#8217;ve been doing a lot of playing with <a href="http://nodejs.org">Node.js</a>, mostly to run data collection scripts. Last week, I started following <a href="http://howtonode.org/express-mongodb">Ciaran Jessup&#8217;s tutorial</a> on getting started with <a href="http://nodejs.org">node.js</a>, <a href="http://github.com/visionmedia/express">Express</a> and <a href="http://www.mongodb.org/">mongoDB</a>. Express acts as a framework to node.js, allowing you to work in a familiar mvc format in a not so familar <a href="http://en.wikipedia.org/wiki/JavaScript">server side language</a>. I hit a few problems along the way in the tutorial, so I thought I&#8217;ve list a few of my findings here. I also wanted to make use of my preferred flavour of nosql &#8211; <a href="http://couchdb.apache.org/">couchdb</a> with express, which proved extremely easy to port the mongo model over to it. I hope someone out there finds this useful as I&#8217;ve yet to find a vast community using couchdb/express.</p>
<p>First things first, you&#8217;ll want to install <a href="http://nodejs.org">Node</a> and <a href="http://npmjs.org">npm</a> (the node package manager) in order to be able to easily install node packages. You&#8217;ll also probably find it handy to have the <a href="http://howtonode.org/express-mongodb">original tutorial open</a> alongside this one. I&#8217;ve been using the latest versions of node (0.3.7) and npm (0.2.17) at the time of writing.</p>
<p>Once that&#8217;s done, grab copies of the packages that we&#8217;ll be using:</p>
<div class='hljs'><pre><code class='bash'>npm install express</code></pre></div><div class='hljs'><pre><code class='bash'>npm install jade</code></pre></div><div class='hljs'><pre><code class='bash'>npm install sass</code></pre></div><p>If you want to use couchdb, then make sure you have it installed &#8211; grab it over <a href="http://www.couchone.com/get">here</a> and then install the package for talking to node.</p>
<div class='hljs'><pre><code class='bash'>npm install cradle</code></pre></div><p>The first hurdle I found was that the way in which that express is called has changed a little.</p>
<div class='hljs'><pre><code class='javascript'><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-keyword">var</span> app = express.createServer();

app.configure(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  app.use(express.methodOverride());
  app.use(express.bodyDecoder());
  app.use(express.logger());
});

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
    res.send(<span class="hljs-string">'Hello World'</span>);
});

app.listen(<span class="hljs-number">3000</span>);</code></pre></div><p>Then by saving to a file called app.js and calling using:</p>
<div class='hljs'><pre><code class='bash'>node app.js</code></pre></div><p>Once that&#8217;s done. You can then visit 127.0.0.1:3000 in your browser to see a rivetting message!</p>
<p>After creating folder beneath our original app.js in which to put views, you can use the original <a href="http://howtonode.org/express-mongodb/articleprovider-memory.js">article provider file</a> and the updated app.js below in order to have an app with a few articles shown.</p>
<div class='hljs'><pre><code class='javascript'><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-keyword">var</span> ArticleProvider = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./articleprovider-memory'</span>).ArticleProvider;

<span class="hljs-keyword">var</span> app = express.createServer();

app.configure(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  app.use(express.methodOverride());
  app.use(express.bodyDecoder());
  app.use(express.logger());
});

<span class="hljs-keyword">var</span> articleProvider= <span class="hljs-keyword">new</span> ArticleProvider();

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>{
  articleProvider.findAll(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, docs</span>)</span>{
    res.send(<span class="hljs-built_in">require</span>(<span class="hljs-string">'sys'</span>).inspect(docs));
  })
});

app.listen(<span class="hljs-number">3000</span>);</code></pre></div><p>Now when you re-run, you&#8217;ll see 3 separate articles. Oooh fancy!</p>
<p>Next I hit my first hurdle. Express no longer uses the HAML HTML template language and instead uses JADE by default. This requires converting the HAML templates across to their equivalent JADE counterparts. Basically, this is as simple as dropping the &#8216;%&#8217; from the beginning of each line (I also replaced braces with brackets in later templates).</p>
<div class='hljs'><pre><code class='jade'>html
  head
    title= title
    link(rel: 'stylesheet', href: '/style.css' )
  body
    #wrapper
      != body</code></pre></div><div class='hljs'><pre><code class='jade'>h1= title
#articles
  - each article in articles
    div.article
      div.created_at= article.created_at
      div.title= article.title
      div.body= article.body</code></pre></div><p>The app.js now becomes:</p>
<div class='hljs'><pre><code class='javascript'><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-keyword">var</span> app = express.createServer();

app.configure(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jade'</span>);
  app.set(<span class="hljs-string">'views'</span>, __dirname + <span class="hljs-string">'/views'</span>);
  app.use(express.methodOverride());
  app.use(express.bodyDecoder());
  app.use(express.logger());
  app.use(app.router);
  app.use(express.compiler({ src: __dirname + <span class="hljs-string">'/views'</span>, enable: [<span class="hljs-string">'sass'</span>] }));
});

<span class="hljs-keyword">var</span> ArticleProvider = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./articleprovider-memory'</span>).ArticleProvider;

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
  articleProvider.findAll(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, docs</span>)</span>{
    res.render(<span class="hljs-string">'blogs_index.jade'</span>, {
      locals: {
        title: <span class="hljs-string">'Blog'</span>,
        articles: docs
      }
    });
  })
})

app.get(<span class="hljs-string">'/*.css'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
  res.render(req.params[<span class="hljs-number">0</span>] + <span class="hljs-string">'.css.sass'</span>, { layout: <span class="hljs-literal">false</span> });
});

app.listen(<span class="hljs-number">3000</span>);</code></pre></div><p>You&#8217;ll notice that here we enable the CSS compiler sass and HTML compiler jade. If you download the original <a href="http://howtonode.org/express-mongodb/views/style.css.sass">sass CSS template</a> into your views folder, you can now restart the app and inspect the fruits of your labour. The CSS shouldn&#8217;t actually sit in the views folder, according to the creator of Express, and should instead should be compiled with the sass package itself. I&#8217;ve yet to discover the correct way of doing this. To request a stylesheet in the view, we need to do the following:</p>
<div class='hljs'><pre><code class='jade'>html
  head
    title= title
    link(rel: 'stylesheet', href: '/style.css' )
  body
    #wrapper
      != body</code></pre></div><p>If you reload now and visit <a href="http://127.0.0.1:3000">127.0.0.1:3000</a> you should see your posts with a little more style.</p>
<p>Creating a form for new posts looks like this:</p>
<div class='hljs'><pre><code class='jade'>h1= title
form( method= 'post' )
  div
    div
      span Title :
      input(type='text', name= 'title', id= 'editArticleTitle' )
    div
      span Body :
      textarea( name= 'body', rows= 20, id= 'editArticleBody' )
    div#editArticleSubmit
      input( type= 'submit', value= 'Send' )</code></pre></div><p>And the new app.js routes are as follows:</p>
<div class='hljs'><pre><code class='javascript'>app.get(<span class="hljs-string">'/blog/new'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
  res.render(<span class="hljs-string">'blog_new'</span>, {
    locals: {
      title: <span class="hljs-string">'New Post'</span>
    }
  });
});

app.post(<span class="hljs-string">'/blog/new'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
  articleProvider.save({
    title: req.param(<span class="hljs-string">'title'</span>),
    body: req.param(<span class="hljs-string">'body'</span>)
  }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, docs</span>) </span>{
    res.redirect(<span class="hljs-string">'/'</span>)
  });
});</code></pre></div><p>In order to add persistence using mongodb, nothing changes in the original model file, <a href="http://howtonode.org/express-mongodb/articleprovider-mongodb.js">so go ahead and use that</a>. You&#8217;ll need to have installed the package &#8216;mongodb&#8217; if you&#8217;d like to try out using it though and update your instantiation of the articleprovider class by supplying a port number to which mongo is installed.</p>
<h1 id="adding-couchdb-persistence">Adding CouchDB Persistence</h1>
<p>Here, I took my own angle on the tutorial and decided to give attempting to make my own persistence model using couchdb a go. It proved to be extremely easy, given the JSON representation and HTTP/GET method of access already built in to it.</p>
<div class='hljs'><pre><code class='javascript'><span class="hljs-keyword">var</span> cradle = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cradle'</span>);

ArticleProvider = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">host, port</span>) </span>{
  <span class="hljs-keyword">this</span>.connection= <span class="hljs-keyword">new</span> (cradle.Connection)(host, port, {
    cache: <span class="hljs-literal">true</span>,
    raw: <span class="hljs-literal">false</span>
  });
  <span class="hljs-keyword">this</span>.db = <span class="hljs-keyword">this</span>.connection.database(<span class="hljs-string">'articles'</span>);
};

ArticleProvider.prototype.findAll = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">this</span>.db.view(<span class="hljs-string">'articles/all'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, result</span>) </span>{
      <span class="hljs-keyword">if</span>( error ){
        callback(error)
      }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">var</span> docs = [];
        result.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">row</span>)</span>{
          docs.push(row);
        });
        callback(<span class="hljs-literal">null</span>, docs);
      }
    });
};

ArticleProvider.prototype.findById = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, callback</span>) </span>{
    <span class="hljs-keyword">this</span>.db.get(id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, result</span>) </span>{
        <span class="hljs-keyword">if</span>( error ) callback(error)
        <span class="hljs-keyword">else</span> callback(<span class="hljs-literal">null</span>, result)
      });
};

ArticleProvider.prototype.save = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">articles, callback</span>) </span>{
    <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span>(articles.length)==<span class="hljs-string">"undefined"</span>)
      articles = [articles];

    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i =<span class="hljs-number">0</span>;i&lt; articles.length;i++ ) {
      article = articles[i];
      article.created_at = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      <span class="hljs-keyword">if</span>( article.comments === <span class="hljs-literal">undefined</span> ) article.comments = [];
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j =<span class="hljs-number">0</span>;j&lt; article.comments.length; j++) {
        article.comments[j].created_at = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      }
    }

    <span class="hljs-keyword">this</span>.db.save(articles, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, result</span>) </span>{
      <span class="hljs-keyword">if</span>( error ) callback(error)
      <span class="hljs-keyword">else</span> callback(<span class="hljs-literal">null</span>, articles);
    });
};

exports.ArticleProvider = ArticleProvider;</code></pre></div><p>I added the following view and route to my app.js too, to allow support for clicking upon articles.</p>
<div class='hljs'><pre><code class='jade'>div.article
  h1= article.title
  div.created_at= article.created_at
  div.body= article.body</code></pre></div><div class='hljs'><pre><code class='javascript'>app.get(<span class="hljs-string">'/blog/view/:id'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
   articleProvider.findById(req.params.id,
     <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, doc</span>)</span>{
       res.render(<span class="hljs-string">'blog_view'</span>, {
       locals: {
         title: <span class="hljs-string">'New Post'</span>,
         article: doc
       }
     });
  });
});</code></pre></div><p>And in order to support it, the main view now becomes as follows:</p>
<div class='hljs'><pre><code class='jade'>h1= title
#articles
  - each article in articles
    div.article
      div.created_at= article.created_at
      - var articlelink = 'blog/view/' + article._id;
      a(href=articlelink)
        div.title= article.title
      div.body= article.body

  a(href='blog/new')
    Add new post</code></pre></div><p>Anyway, so far I&#8217;ve not yet added comment support, but given the headway I made here, I&#8217;d imagine it would be extremely easy to integrate into my couchdb article model. I&#8217;ll update here if I ever get round to adding it!</p>


          <div class="entry_content">Tagged
              
                
                <a href="/tag/couchdb">couchdb</a>,
                
                <a href="/tag/expressjs">expressjs</a>,
                
                <a href="/tag/mongdb">mongdb</a>,
                
                <a href="/tag/node">node</a>,
                
                <a href="/tag/nodejs">nodejs</a>,
                
              
              | <a href="2011/02/07/blog-rolling-with-couchdb-express-and-node-js/#disqus_thread">Leave a comment</a>
          </div>
        </div>
      

      <div class="pagination">
          
          <a href="/category/Javascript" class="previous">Previous</a>
          
          <span class="page_number ">Page: 2 of 2</span>

          
      </div>
    <footer>
      <div class="footer-about">
        I'm a Web Developer  working at <a href="http://niftydigits.com">Nifty Digits</a> in Cardiff, UK. Here, I enjoy talking code - mostly javascript. I'm <a href="http://twitter.com/iwootten">@iwootten</a> on twitter.
      </div>
    </footer>
  </div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ianwootten'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
</body>
</html>

